{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Arbitrage Scanner</title>
    <link rel="stylesheet" href="{% static 'market/css/home.css' %}?{% now 'U' %}">
</head>
<body>
    <!-- CSRF token para JS -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <h1>ü™ô WoW Auction Arbitrage</h1>

    <!-- ===================================================== -->
    <h2 id="add-item-title" class="collapsible">‚ûï Agregar nuevo item</h2>
    <div id="add-item-container">
        <table id="add-item-table">
            <thead>
                <tr>
                    <th>Nombre del item</th>
                    <th>Profesi√≥n</th>
                    <th>Decor Item</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <input type="text" id="new-item-name" placeholder="Escribe el nombre del item" style="width: 100%;">
                    </td>
                    <td>
                        <select id="new-item-profession" style="width: 100%;">
                            <option value="">-- Sin profesi√≥n --</option>
                            {% for prof in professions %}
                            <option value="{{ prof.id }}">{{ prof.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="checkbox" id="new-item-decor">
                        <label for="new-item-decor">Es decorativo</label>
                    </td>
                    <td>
                        <button id="add-item-btn">Agregar</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr>

    <h2 id="scan-items-title" class="collapsible">üéØ Items a escanear</h2>
    <div id="scan-items-container">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-items"></th>
                    <th>Item ID (Blizzard)</th>
                    <th>Item</th>
                    <th>Icono</th>
                    <th>A√±adido el</th>
                    <th>Activo</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr id="item-row-{{ item.id }}">
                    <td>
                        <input type="checkbox" class="item-check" value="{{ item.id }}" {% if item.tracking and item.tracking.active %}checked{% endif %}>
                    </td>
                    <td>{{ item.blizzard_id|default:"-" }}</td>
                    <td>{{ item.name }}</td>
                    <td>
                        {% if item.icon %}
                        <img src="{{ item.icon.url }}" alt="{{ item.name }} icon" style="width: 50px; height: 50px;">
                        {% else %}
                        <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_rune_01.jpg"
                            alt="{{ item.name }} icon"
                            style="width: 50px; height: 50px;">
                        {% endif %}
                    </td>
                    <!-- Usar data-attribute para la fecha ISO (UTC) -->
                    <td class="date-cell" data-iso-date="{% if item.tracking %}{{ item.tracking.created_at|date:'c' }}{% endif %}">
                        {% if item.tracking %}
                            Cargando...
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{% if item.tracking and item.tracking.active %}‚úÖ{% else %}‚ùå{% endif %}</td>
                    <td>
                        <button class="delete-item-btn" data-id="{{ item.id }}">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 15px;">
            <button id="save-tracked">üíæ Guardar selecci√≥n</button>
            <button id="delete-selected-items">üóëÔ∏è Eliminar seleccionados</button>
            <button id="delete-all-items">üî• Eliminar todos</button>
        </div>
    </div>

    <hr>

    <h2 id="arbitrage-results-title" class="collapsible">üìà Resultados de arbitraje</h2>
    <div id="arbitrage-results-container">
        {% if snapshots %}
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-snapshots"></th>
                    <th>Item ID</th>
                    <th>Item</th>
                    <th>Icono</th>
                    <th>Snapshot tomado</th> <!-- MOVIDO AQU√ç -->
                    <th>Buy Realm</th>
                    <th>Buy Price</th>
                    <th>Sell Realm</th>
                    <th>Sell Price</th>
                    <th>Profit</th>
                </tr>
            </thead>
            <tbody>
                {% for s in snapshots %}
                <tr>
                    <td><input type="checkbox" class="snapshot-check" value="{{ s.id }}"></td>
                    <td>{{ s.item.blizzard_id }}</td>
                    <td>{{ s.item.name }}</td>
                    <td>
                        {% if s.item.icon %}
                        <img src="{{ s.item.icon.url }}" alt="{{ s.item.name }} icon" style="width: 50px; height: 50px;">
                        {% else %}
                        <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_rune_01.jpg"
                            alt="{{ s.item.name }} icon"
                            style="width: 50px; height: 50px;">
                        {% endif %}
                    </td>
                    <!-- Usar data-attribute para la fecha ISO (UTC) - MOVIDO AQU√ç -->
                    <td class="date-cell" data-iso-date="{{ s.created_at|date:'c' }}">
                        Cargando...
                    </td>
                    <td>{{ s.best_buy_realm.name }}</td>
                    <td>{{ s.buy_price }} g</td>
                    <td>{{ s.best_sell_realm.name }}</td>
                    <td>{{ s.estimated_sell_price }} g</td>
                    <td class="profit">{{ s.profit }} g</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 15px;">
            <button id="delete-selected">üóëÔ∏è Eliminar seleccionados</button>
            <button id="delete-all">üî• Eliminar todos</button>
        </div>
        {% else %}
        <p>No arbitrage data available yet.</p>
        {% endif %}
    </div>

    <hr>

    <button id="update-btn">üîÑ Update Auctions</button>

    <div id="progress-box">
        <p>‚è≥ Estado: <span id="state">Idle</span></p>
        <p>üåç Reino actual: <span id="current">-</span></p>
        <p>üìä Progreso: <span id="done">0</span>/<span id="total">0</span></p>
        <p>‚è±Ô∏è Tiempo: <span id="elapsed">0</span>s</p>
        <p>‚åõ ETA: <span id="eta">0</span>s</p>
    </div>

    <!-- JS externo -->
    <script src="{% static 'market/js/home.js' %}"></script>
    
    <!-- Nuevo script para formatear fechas en hora local -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Funci√≥n para formatear fecha ISO a hora local DD/MM HH:MM
        function formatDateToLocal(isoDateString) {
            if (!isoDateString) return '-';
            
            try {
                const date = new Date(isoDateString);
                
                // Verificar si la fecha es v√°lida
                if (isNaN(date.getTime())) {
                    console.error('Fecha inv√°lida:', isoDateString);
                    return 'Fecha inv√°lida';
                }
                
                // Obtener d√≠a, mes, horas y minutos
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Los meses van de 0-11
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${day}/${month} ${hours}:${minutes}`;
            } catch (error) {
                console.error('Error formateando fecha:', error, isoDateString);
                return 'Error';
            }
        }
        
        // Convertir todas las fechas en la p√°gina
        function convertAllDates() {
            const dateCells = document.querySelectorAll('.date-cell[data-iso-date]');
            
            dateCells.forEach(cell => {
                const isoDate = cell.getAttribute('data-iso-date');
                if (isoDate && isoDate !== 'None') {
                    const localDate = formatDateToLocal(isoDate);
                    cell.textContent = localDate;
                } else {
                    cell.textContent = '-';
                }
            });
        }
        
        // Convertir fechas cuando se cargue la p√°gina
        convertAllDates();
        
        // Tambi√©n convertir fechas cuando se actualicen los snapshots din√°micamente
        // (esto funcionar√° con tu JavaScript existente)
        
        // Funci√≥n helper para usar en otros lugares
        window.formatDateToLocal = formatDateToLocal;
    });
    </script>
</body>
</html>