{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Arbitrage Scanner</title>
    <link rel="stylesheet" href="{% static 'market/css/home.css' %}?{% now 'U' %}">
</head>
<body>
    <!-- CSRF token para JS -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <h1>ü™ô WoW Auction Arbitrage</h1>

    <!-- ===================================================== -->
    <h2 id="add-item-title" class="collapsible">‚ûï Agregar nuevo item</h2>
    <div id="add-item-container">
        <table id="add-item-table">
            <thead>
                <tr>
                    <th>Nombre del item</th>
                    <th>Profesi√≥n</th>
                    <th>Decor Item</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <input type="text" id="new-item-name" placeholder="Escribe el nombre del item" style="width: 100%;">
                    </td>
                    <td>
                        <select id="new-item-profession" style="width: 100%;">
                            <option value="">-- Sin profesi√≥n --</option>
                            {% for prof in professions %}
                            <option value="{{ prof.id }}">{{ prof.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="checkbox" id="new-item-decor">
                        <label for="new-item-decor">Es decorativo</label>
                    </td>
                    <td>
                        <button id="add-item-btn">Agregar</button>
                    </td>
                </tr>
                <!-- Nueva fila para cargar archivo TXT -->
                <tr>
                    <td colspan="4" style="text-align: center; padding-top: 15px;">
                        <hr style="margin: 10px 0;">
                        <strong>O cargar m√∫ltiples items desde archivo TXT:</strong>
                        <div style="margin-top: 10px;">
                            <input type="file" id="txt-file-input" accept=".txt" style="margin-bottom: 10px;">
                            <br>
                            <button id="load-txt-btn">üìÅ Cargar y Procesar TXT</button>
                            <button id="download-template-btn" style="margin-left: 10px; background-color: #6c757d;">
                                üìã Descargar plantilla
                            </button>
                        </div>
                        <div id="file-info" style="margin-top: 10px; font-size: 0.9em; color: #ccc; display: none;">
                            Archivo cargado: <span id="file-name"></span> 
                            (<span id="item-count">0</span> items detectados)
                        </div>
                        <div id="processing-status" style="display: none; margin-top: 10px;">
                            <div style="color: #4CAF50;">‚è≥ Procesando items...</div>
                            <div id="progress-text">0/0 completados</div>
                            <div id="success-count" style="color: #4CAF50; display: none;">‚úÖ <span>0</span> items a√±adidos exitosamente</div>
                            <div id="error-count" style="color: #ff6b6b; display: none;">‚ùå <span>0</span> errores</div>
                        </div>
                        <div class="format-example" style="margin-top: 10px;">
                            <strong>Formato del archivo TXT:</strong>
                            <pre style="margin: 5px 0; font-size: 0.85em;">
Item normal 1
Item normal 2
Item decorativo,decor
Item normal 3,Enchanting
Item decorativo con profesi√≥n,decor,Jewelcrafting
Item en espa√±ol,Alquimia</pre>
                            <em style="font-size: 0.8em;">Un item por l√≠nea. Para items decorativos a√±ade ",decor". Para profesi√≥n a√±ade ",NombreProfesi√≥n".</em>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr>

    <h2 id="scan-items-title" class="collapsible">üéØ Items a escanear</h2>
    <div id="scan-items-container">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-items"></th>
                    <th>Item ID (Blizzard)</th>
                    <th>Item</th>
                    <th>Icono</th>
                    <th>Profesi√≥n</th> <!-- NUEVA COLUMNA -->
                    <th>A√±adido el</th>
                    <th>Activo</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr id="item-row-{{ item.id }}">
                    <td>
                        <input type="checkbox" class="item-check" value="{{ item.id }}" {% if item.tracking and item.tracking.active %}checked{% endif %}>
                    </td>
                    <td>{{ item.blizzard_id|default:"-" }}</td>
                    <td>
                        {{ item.name }}
                        {% if item.icon and "inv_misc_rune" not in item.icon.url %}
                        <span class="decor-badge" style="font-size: 0.7em; color: #ffc107; margin-left: 5px;">
                            {% if "decor" in item.name|lower or item.tracking and item.tracking.is_decor %}
                            üé®
                            {% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.icon %}
                        <img src="{{ item.icon.url }}" alt="{{ item.name }} icon" style="width: 50px; height: 50px;">
                        {% else %}
                        <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_rune_01.jpg"
                            alt="{{ item.name }} icon"
                            style="width: 50px; height: 50px;">
                        {% endif %}
                    </td>
                    <td class="profession-cell">
                        {% if item.profession %}
                        <span class="profession-badge" style="
                            background-color: {% if item.profession.name == 'Alchemy' %}#ff6b6b
                                            {% elif item.profession.name == 'Blacksmithing' %}#4ecdc4
                                            {% elif item.profession.name == 'Enchanting' %}#45b7d1
                                            {% elif item.profession.name == 'Engineering' %}#96ceb4
                                            {% elif item.profession.name == 'Herbalism' %}#feca57
                                            {% elif item.profession.name == 'Inscription' %}#ff9ff3
                                            {% elif item.profession.name == 'Jewelcrafting' %}#54a0ff
                                            {% elif item.profession.name == 'Leatherworking' %}#5f27cd
                                            {% elif item.profession.name == 'Mining' %}#8395a7
                                            {% elif item.profession.name == 'Skinning' %}#ff9f43
                                            {% elif item.profession.name == 'Tailoring' %}#ee5a24
                                            {% elif item.profession.name == 'Cooking' %}#10ac84
                                            {% elif item.profession.name == 'Fishing' %}#0abde3
                                            {% elif item.profession.name == 'Archaeology' %}#576574
                                            {% else %}#6c757d{% endif %};
                            color: white;
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-size: 0.75em;
                            white-space: nowrap;
                            display: inline-block;
                        ">
                            {{ item.profession.name }}
                        </span>
                        {% else %}
                        <span style="color: #94a3b8; font-style: italic; font-size: 0.85em;">-</span>
                        {% endif %}
                    </td>
                    <!-- Usar data-attribute para la fecha ISO (UTC) -->
                    <td class="date-cell" data-iso-date="{% if item.tracking %}{{ item.tracking.created_at|date:'c' }}{% endif %}">
                        {% if item.tracking %}
                            Cargando...
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="active-cell">
                        {% if item.tracking and item.tracking.active %}
                        <span style="color: #4CAF50; font-weight: bold;">‚úÖ</span>
                        {% else %}
                        <span style="color: #dc3545; font-weight: bold;">‚ùå</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="delete-item-btn" data-id="{{ item.id }}">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 15px;">
            <button id="save-tracked">üíæ Guardar selecci√≥n</button>
            <button id="delete-selected-items">üóëÔ∏è Eliminar seleccionados</button>
            <button id="delete-all-items">üî• Eliminar todos</button>
        </div>
    </div>

    <hr>

    <h2 id="arbitrage-results-title" class="collapsible">üìà Resultados de arbitraje</h2>
    <div id="arbitrage-results-container">
        {% if snapshots %}
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-snapshots"></th>
                    <th>Item ID</th>
                    <th>Item</th>
                    <th>Icono</th>
                    <th>Snapshot tomado</th>
                    <th>Profesi√≥n</th> <!-- NUEVA COLUMNA -->
                    <th>Buy Realm</th>
                    <th>Buy Price</th>
                    <th>Sell Realm</th>
                    <th>Sell Price</th>
                    <th>Profit</th>
                </tr>
            </thead>
            <tbody>
                {% for s in snapshots %}
                <tr>
                    <td><input type="checkbox" class="snapshot-check" value="{{ s.id }}"></td>
                    <td>{{ s.item.blizzard_id }}</td>
                    <td>
                        {{ s.item.name }}
                        {% if s.item.icon and "inv_misc_rune" not in s.item.icon.url %}
                        <span class="decor-badge" style="font-size: 0.7em; color: #ffc107; margin-left: 5px;">
                            {% if "decor" in s.item.name|lower %}
                            üé®
                            {% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.item.icon %}
                        <img src="{{ s.item.icon.url }}" alt="{{ s.item.name }} icon" style="width: 50px; height: 50px;">
                        {% else %}
                        <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_rune_01.jpg"
                            alt="{{ s.item.name }} icon"
                            style="width: 50px; height: 50px;">
                        {% endif %}
                    </td>
                    <!-- Usar data-attribute para la fecha ISO (UTC) -->
                    <td class="date-cell" data-iso-date="{{ s.created_at|date:'c' }}">
                        Cargando...
                    </td>
                    <td class="profession-cell">
                        {% if s.item.profession %}
                        <span class="profession-badge" style="
                            background-color: {% if s.item.profession.name == 'Alchemy' %}#ff6b6b
                                            {% elif s.item.profession.name == 'Blacksmithing' %}#4ecdc4
                                            {% elif s.item.profession.name == 'Enchanting' %}#45b7d1
                                            {% elif s.item.profession.name == 'Engineering' %}#96ceb4
                                            {% elif s.item.profession.name == 'Herbalism' %}#feca57
                                            {% elif s.item.profession.name == 'Inscription' %}#ff9ff3
                                            {% elif s.item.profession.name == 'Jewelcrafting' %}#54a0ff
                                            {% elif s.item.profession.name == 'Leatherworking' %}#5f27cd
                                            {% elif s.item.profession.name == 'Mining' %}#8395a7
                                            {% elif s.item.profession.name == 'Skinning' %}#ff9f43
                                            {% elif s.item.profession.name == 'Tailoring' %}#ee5a24
                                            {% elif s.item.profession.name == 'Cooking' %}#10ac84
                                            {% elif s.item.profession.name == 'Fishing' %}#0abde3
                                            {% elif s.item.profession.name == 'Archaeology' %}#576574
                                            {% else %}#6c757d{% endif %};
                            color: white;
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-size: 0.75em;
                            white-space: nowrap;
                            display: inline-block;
                        ">
                            {{ s.item.profession.name }}
                        </span>
                        {% else %}
                        <span style="color: #94a3b8; font-style: italic; font-size: 0.85em;">-</span>
                        {% endif %}
                    </td>
                    <td>{{ s.best_buy_realm.name }}</td>
                    <td>{{ s.buy_price }} g</td>
                    <td>{{ s.best_sell_realm.name }}</td>
                    <td>{{ s.estimated_sell_price }} g</td>
                    <td class="profit">{{ s.profit }} g</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 15px;">
            <button id="delete-selected">üóëÔ∏è Eliminar seleccionados</button>
            <button id="delete-all">üî• Eliminar todos</button>
        </div>
        {% else %}
        <p>No arbitrage data available yet.</p>
        {% endif %}
    </div>

    <hr>

    <button id="update-btn">üîÑ Update Auctions</button>

    <div id="progress-box">
        <p>‚è≥ Estado: <span id="state">Idle</span></p>
        <p>üåç Reino actual: <span id="current">-</span></p>
        <p>üìä Progreso: <span id="done">0</span>/<span id="total">0</span></p>
        <p>‚è±Ô∏è Tiempo: <span id="elapsed">0</span>s</p>
        <p>‚åõ ETA: <span id="eta">0</span>s</p>
    </div>

    <!-- JS externo -->
    <script src="{% static 'market/js/home.js' %}?{% now 'U' %}"></script>
</body>
</html>