{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Arbitrage Scanner</title>
    <link rel="stylesheet" href="{% static 'market/css/home.css' %}">
</head>
<body>

<h1>ğŸª™ WoW Auction Arbitrage</h1>

<!-- ===================================================== -->
<!-- â• AGREGAR NUEVO ITEM -->
<!-- ===================================================== -->

<h2>â• Agregar nuevo item</h2>

<table id="add-item-table">
    <thead>
        <tr>
            <th>Nombre del item</th>
            <th>ProfesiÃ³n</th>
            <th>AcciÃ³n</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <input type="text" id="new-item-name" placeholder="Escribe el nombre del item" style="width: 100%;">
            </td>
            <td>
                <select id="new-item-profession" style="width: 100%;">
                    <option value="">-- Sin profesiÃ³n --</option>
                    {% for prof in professions %}
                    <option value="{{ prof.id }}">{{ prof.name }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <button id="add-item-btn">Agregar</button>
            </td>
        </tr>
    </tbody>
</table>

<!-- ===================================================== -->
<!-- ğŸ¯ TABLA 1: ITEMS A ESCANEAR -->
<!-- ===================================================== -->

<h2>ğŸ¯ Items a escanear</h2>

<table>
    <thead>
        <tr>
            <th><input type="checkbox" id="select-all-items"></th>
            <th>Item</th>
            <th>Activo</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td>
                <input type="checkbox" class="item-check" value="{{ item.id }}"
                       {% if item.tracking and item.tracking.active %}checked{% endif %}>
            </td>
            <td>{{ item.name }}{% if item.profession %} ({{ item.profession.name }}){% endif %}</td>
            <td>{% if item.tracking and item.tracking.active %}âœ…{% else %}âŒ{% endif %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button id="save-tracked">ğŸ’¾ Guardar selecciÃ³n</button>

<hr>

<!-- ===================================================== -->
<!-- ğŸ“ˆ TABLA 2: RESULTADOS DE ARBITRAJE -->
<!-- ===================================================== -->

<h2>ğŸ“ˆ Resultados de arbitraje</h2>

{% if snapshots %}
<table>
    <thead>
        <tr>
            <th><input type="checkbox" id="select-all-snapshots"></th>
            <th>Item</th>
            <th>Buy Realm</th>
            <th>Buy Price</th>
            <th>Sell Realm</th>
            <th>Sell Price</th>
            <th>Profit</th>
        </tr>
    </thead>
    <tbody>
        {% for s in snapshots %}
        <tr>
            <td><input type="checkbox" class="snapshot-check" value="{{ s.id }}"></td>
            <td>{{ s.item.name }}</td>
            <td>{{ s.best_buy_realm.name }}</td>
            <td>{{ s.buy_price }} g</td>
            <td>{{ s.best_sell_realm.name }}</td>
            <td>{{ s.estimated_sell_price }} g</td>
            <td class="profit">{{ s.profit }} g</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 15px;">
    <button id="delete-selected">ğŸ—‘ï¸ Eliminar seleccionados</button>
    <button id="delete-all">ğŸ”¥ Eliminar todos</button>
</div>
{% else %}
<p>No arbitrage data available yet.</p>
{% endif %}

<hr>

<button id="update-btn">ğŸ”„ Update Auctions</button>

<div id="progress-box">
    <p>â³ Estado: <span id="state">Idle</span></p>
    <p>ğŸŒ Reino actual: <span id="current">-</span></p>
    <p>ğŸ“Š Progreso: <span id="done">0</span>/<span id="total">0</span></p>
    <p>â±ï¸ Tiempo: <span id="elapsed">0</span>s</p>
    <p>âŒ› ETA: <span id="eta">0</span>s</p>
</div>

<!-- ===================================================== -->
<!-- JS -->
<!-- ===================================================== -->

<script>
// Update Auctions Polling
const btn = document.getElementById("update-btn");
let poller = null;
let wasRunning = false;

function startPolling() { if (!poller) poller = setInterval(updateStatus, 2000); }
function stopPolling() { if (poller) { clearInterval(poller); poller = null; } }

function updateStatus() {
    fetch("{% url 'auction_status' %}")
        .then(r => r.json())
        .then(data => {
            if (data.running) {
                wasRunning = true;
                state.innerText = "Running";
                current.innerText = data.current || "-";
                done.innerText = data.done || 0;
                total.innerText = data.total || 0;
                elapsed.innerText = data.elapsed || 0;
                eta.innerText = data.eta || 0;
                btn.disabled = true;
            } else {
                state.innerText = "Idle";
                btn.disabled = false;
                stopPolling();
                if (wasRunning) location.reload();
            }
        });
}

btn.addEventListener("click", () => {
    btn.disabled = true;
    fetch("{% url 'update_auctions' %}", { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } });
    startPolling();
});

// Track Items
document.getElementById("select-all-items")?.addEventListener("change", e => {
    document.querySelectorAll(".item-check").forEach(cb => cb.checked = e.target.checked);
});
document.getElementById("save-tracked")?.addEventListener("click", () => {
    const ids = [...document.querySelectorAll(".item-check:checked")].map(cb => cb.value);
    fetch("{% url 'update_tracked_items' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ item_ids: ids })
    }).then(() => { alert("âœ… Items a escanear actualizados"); location.reload(); });
});

// Delete Snapshots
document.getElementById("select-all-snapshots")?.addEventListener("change", e => {
    document.querySelectorAll(".snapshot-check").forEach(cb => cb.checked = e.target.checked);
});
document.getElementById("delete-selected")?.addEventListener("click", () => {
    const ids = [...document.querySelectorAll(".snapshot-check:checked")].map(cb => cb.value);
    if (!ids.length) return alert("Nada seleccionado");
    fetch("{% url 'delete_snapshots' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ ids })
    }).then(() => location.reload());
});
document.getElementById("delete-all")?.addEventListener("click", () => {
    if (!confirm("Eliminar TODOS los snapshots?")) return;
    fetch("{% url 'delete_all_snapshots' %}", { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } })
        .then(() => location.reload());
});

// Add Item con ProfesiÃ³n
document.getElementById("add-item-btn")?.addEventListener("click", () => {
    const name = document.getElementById("new-item-name").value.trim();
    const prof = document.getElementById("new-item-profession").value;
    if (!name) return alert("Escribe un nombre de item");

    fetch("{% url 'add_item' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ name, profession_id: prof })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.ok) return alert("Error: " + (data.error || "desconocido"));
        document.getElementById("new-item-name").value = "";
        document.getElementById("new-item-profession").value = "";
        location.reload();
    });
});
</script>

</body>
</html>
