{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Arbitrage Scanner</title>
    <link rel="stylesheet" href="{% static 'market/css/home.css' %}?{% now 'U' %}">
</head>
<body>
    <!-- CSRF token para JS -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <h1>ü™ô WoW Auction Arbitrage</h1>

    <!-- Controles de m√∫sica -->
    <div style="text-align: center; margin: 10px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
            <button id="music-toggle-btn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;" title="Haz clic para reproducir m√∫sica de fondo">
                üéµ Play Music
            </button>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="color: #a5b4fc; font-size: 12px;">üîä</span>
                <input type="range" id="volume-slider" min="0" max="100" value="10" style="width: 100px; accent-color: #4CAF50;">
                <span id="volume-value" style="color: #a5b4fc; font-size: 12px; min-width: 30px;">10%</span>
            </div>
        </div>
        
        <!-- Visualizaci√≥n del track actual -->
        <div id="music-visualizer" style="margin-top: 10px; display: none;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div id="track-bars" style="display: flex; gap: 2px; height: 20px; align-items: end;">
                    <div class="bar" style="width: 4px; background: #4CAF50; border-radius: 2px; transition: height 0.3s ease;"></div>
                    <div class="bar" style="width: 4px; background: #4CAF50; border-radius: 2px; transition: height 0.3s ease;"></div>
                    <div class="bar" style="width: 4px; background: #4CAF50; border-radius: 2px; transition: height 0.3s ease;"></div>
                    <div class="bar" style="width: 4px; background: #4CAF50; border-radius: 2px; transition: height 0.3s ease;"></div>
                    <div class="bar" style="width: 4px; background: #4CAF50; border-radius: 2px; transition: height 0.3s ease;"></div>
                </div>
                <span id="current-track-name" style="color: #a5b4fc; font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
            </div>
        </div>
    </div>

    <!-- ===================================================== -->
    <h2 id="add-item-title" class="collapsible">‚ûï Agregar nuevo item</h2>
    <div id="add-item-container">
        <table id="add-item-table">
            <thead>
                <tr>
                    <th>Nombre del item</th>
                    <th>Profesi√≥n</th>
                    <th>Decor Item</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <input type="text" id="new-item-name" placeholder="Escribe el nombre del item" style="width: 100%;">
                    </td>
                    <td>
                        <select id="new-item-profession" style="width: 100%;">
                            <option value="">-- Sin profesi√≥n --</option>
                            {% for prof in professions %}
                            <option value="{{ prof.id }}">{{ prof.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="checkbox" id="new-item-decor">
                        <label for="new-item-decor">Es decorativo</label>
                    </td>
                    <td>
                        <button id="add-item-btn">Agregar</button>
                    </td>
                </tr>
                <!-- Nueva fila para cargar archivo TXT -->
                <tr>
                    <td colspan="4" style="text-align: center; padding-top: 15px;">
                        <hr style="margin: 10px 0;">
                        <strong>O cargar m√∫ltiples items desde archivo TXT:</strong>
                        <div style="margin-top: 10px;">
                            <input type="file" id="txt-file-input" accept=".txt" style="margin-bottom: 10px;">
                            <br>
                            <button id="load-txt-btn">üìÅ Cargar y Procesar TXT</button>
                            <button id="download-template-btn" style="margin-left: 10px; background-color: #6c757d;">
                                üìã Descargar plantilla
                            </button>
                        </div>
                        <div id="file-info" style="margin-top: 10px; font-size: 0.9em; color: #ccc; display: none;">
                            Archivo cargado: <span id="file-name"></span> 
                            (<span id="item-count">0</span> items detectados)
                        </div>
                        <div id="processing-status" style="display: none; margin-top: 10px;">
                            <div style="color: #4CAF50;">‚è≥ Procesando items...</div>
                            <div id="progress-text">0/0 completados</div>
                            <div id="success-count" style="color: #4CAF50; display: none;">‚úÖ <span>0</span> items a√±adidos exitosamente</div>
                            <div id="error-count" style="color: #ff6b6b; display: none;">‚ùå <span>0</span> errores</div>
                        </div>
                        <div class="format-example" style="margin-top: 10px;">
                            <strong>Formato del archivo TXT:</strong>
                            <pre style="margin: 5px 0; font-size: 0.85em;">
Item normal 1
Item normal 2
Item decorativo,decor
Item normal 3,Enchanting
Item decorativo con profesi√≥n,decor,Jewelcrafting
Item en espa√±ol,Alquimia</pre>
                            <em style="font-size: 0.8em;">Un item por l√≠nea. Para items decorativos a√±ade ",decor". Para profesi√≥n a√±ade ",NombreProfesi√≥n".</em>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr>

    <!-- ===================================================== -->
    <!-- SECCI√ìN DE CONFIGURACI√ìN -->
    <h2 id="config-title" class="collapsible">‚öôÔ∏è Scanner Configuration</h2>
    <div id="config-container" style="display: none;">
        <div class="config-section">
            <h3>üîç Scan Configuration</h3>
            <p><em>Configure realms to scan for auctions and arbitrage opportunities</em></p>
            
            <!-- Realms List -->
            <div id="primary-realms-container" style="margin-bottom: 20px;">
                <h4>üéØ Realms to Scan</h4>
                <textarea id="realms-textarea" placeholder="Enter one realm per line (e.g. Stormrage&#10;Area 52&#10;Moon Guard)"></textarea>
                <div style="margin-top: 10px;">
                    <button id="load-default-realms-btn" style="padding: 6px 12px; background-color: #6c757d;">
                        üîÑ Load Default
                    </button>
                </div>
                <p style="font-size: 0.9em; color: #ccc; margin-top: 10px;">
                    <strong>Note:</strong> Arbitrage will scan these realms for buy/sell opportunities.
                </p>
            </div>
            
<!-- Scan Options -->
<div>
    <h4>‚öôÔ∏è Scan Options</h4>
    <table>
        <tr>
            <td style="width: 250px; padding-bottom: 15px;">
                <label for="max-realms-input">Max realms to scan:</label>
            </td>
            <td style="padding-bottom: 15px;">
                <input type="number" id="max-realms-input" min="0" max="1000" style="width: 100px; padding: 8px;">
                <span style="margin-left: 10px; font-size: 0.9em; color: #ccc;">
                    (0 = all realms)
                </span>
            </td>
        </tr>

        <tr>
            <td style="padding-bottom: 15px;">
                <label for="dev-mode-checkbox">Development mode:</label>
            </td>
            <td style="padding-bottom: 15px;">
                <input type="checkbox" id="dev-mode-checkbox">
                <label for="dev-mode-checkbox" style="margin-left: 5px;">
                    Limit to 10 realms max (for quick tests)
                </label>
            </td>
        </tr>
    </table>

    <!-- üîπ BOTONES AHORA JUSTO DEBAJO DE DEV MODE -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #444; text-align: center;">
        <button id="update-btn" style="background-color: #007bff; padding: 10px 20px; font-weight: bold;">
            üîÑ Update Auctions
        </button>
        <button id="save-config-btn" style="margin-left: 10px; background-color: #28a745; padding: 10px 20px; font-weight: bold;">
            üíæ Save Configuration
        </button>
        <button id="reset-config-btn" style="margin-left: 10px; background-color: #dc3545; padding: 10px 20px;">
            üîÑ Restore Default Values
        </button>
    </div>

    <div id="config-status"
         style="display: none; margin-top: 15px; padding: 12px; border-radius: 5px; font-weight: 500; text-align: center;"></div>
</div>


                </table>
            </div>
        </div>

        <!-- Estado del escaneo en tiempo real -->
        <div id="auction-status" style="margin-top: 20px; padding: 15px; background-color: #1e293b; border-radius: 8px; border: 1px solid #334155;">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: #60a5fa; display: flex; align-items: center; gap: 8px;">
                <span>üìä</span> Scan Status
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <!-- Estado actual -->
                <div style="background: rgba(96, 165, 250, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #60a5fa;">
                    <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 4px;">Estado</div>
                    <div style="font-weight: bold; color: #e2e8f0; font-size: 1.1em;">
                        <span id="state">Idle</span>
                    </div>
                </div>
                
                <!-- Progreso de reinos -->
                <div style="background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #22c55e;">
                    <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 4px;">Progreso</div>
                    <div style="font-weight: bold; color: #e2e8f0; font-size: 1.1em;">
                        <span id="done">0</span>/<span id="total">0</span> reinos
                    </div>
                    <div style="font-size: 0.75em; color: #94a3b8; margin-top: 4px;">
                        Reino: <span id="current" style="color: #60a5fa;">-</span>
                    </div>
                </div>
                
                <!-- Tiempo transcurrido -->
                <div style="background: rgba(168, 85, 247, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #a855f7;">
                    <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 4px;">Tiempo transcurrido</div>
                    <div style="font-weight: bold; color: #e2e8f0; font-size: 1.1em;">
                        <span id="elapsed">0</span>s
                    </div>
                </div>
                
                <!-- Tiempo estimado -->
                <div style="background: rgba(234, 179, 8, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #eab308;">
                    <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 4px;">ETA</div>
                    <div style="font-weight: bold; color: #e2e8f0; font-size: 1.1em;">
                        <span id="eta">0</span>s
                    </div>
                </div>
                
                <!-- Errores detectados -->
                <div style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #ef4444;">
                    <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 4px;">Errores</div>
                    <div style="font-weight: bold; color: #e2e8f0; font-size: 1.1em;">
                        <span id="error-count">0</span>
                    </div>
                </div>
            </div>
            
            <div id="config-info" style="font-size: 0.85em; color: #94a3b8; margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155;"></div>
        </div>
    </div>

    <hr>

    <h2 id="scan-items-title" class="collapsible">üéØ Items a escanear</h2>
    <div id="scan-items-container" style="display: none;">
        <!-- Contenido existente de items a escanear -->
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-items"></th>
                    <th>Item ID (Blizzard)</th>
                    <th>Item</th>
                    <th>Icono</th>
                    <th>Profesi√≥n</th>
                    <th>A√±adido el</th>
                    <th>Activo</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr id="item-row-{{ item.id }}">
                    <td>
                        <input type="checkbox" class="item-check" value="{{ item.id }}" {% if item.tracking and item.tracking.active %}checked{% endif %}>
                    </td>
                    <td>{{ item.blizzard_id|default:"-" }}</td>
                    <td>
                        {{ item.name }}
                        {% if item.icon and "inv_misc_rune" not in item.icon.url %}
                        <span class="decor-badge" style="font-size: 0.7em; color: #ffc107; margin-left: 5px;">
                            {% if "decor" in item.name|lower or item.tracking and item.tracking.is_decor %}
                            üé®
                            {% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.icon %}
                        <img src="{{ item.icon.url }}" alt="{{ item.name }} icon" style="width: 50px; height: 50px;">
                        {% else %}
                        <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_rune_01.jpg"
                            alt="{{ item.name }} icon"
                            style="width: 50px; height: 50px;">
                        {% endif %}
                    </td>
                    <td class="profession-cell">
                        {% if item.profession %}
                        <span class="profession-badge" style="
                            background-color: {% if item.profession.name == 'Alchemy' %}#ff6b6b
                                            {% elif item.profession.name == 'Blacksmithing' %}#4ecdc4
                                            {% elif item.profession.name == 'Enchanting' %}#45b7d1
                                            {% elif item.profession.name == 'Engineering' %}#96ceb4
                                            {% elif item.profession.name == 'Herbalism' %}#feca57
                                            {% elif item.profession.name == 'Inscription' %}#ff9ff3
                                            {% elif item.profession.name == 'Jewelcrafting' %}#54a0ff
                                            {% elif item.profession.name == 'Leatherworking' %}#5f27cd
                                            {% elif item.profession.name == 'Mining' %}#8395a7
                                            {% elif item.profession.name == 'Skinning' %}#ff9f43
                                            {% elif item.profession.name == 'Tailoring' %}#ee5a24
                                            {% elif item.profession.name == 'Cooking' %}#10ac84
                                            {% elif item.profession.name == 'Fishing' %}#0abde3
                                            {% elif item.profession.name == 'Archaeology' %}#576574
                                            {% else %}#6c757d{% endif %};
                            color: white;
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-size: 0.75em;
                            white-space: nowrap;
                            display: inline-block;
                        ">
                            {{ item.profession.name }}
                        </span>
                        {% else %}
                        <span style="color: #94a3b8; font-style: italic; font-size: 0.85em;">-</span>
                        {% endif %}
                    </td>
                    <td class="date-cell" data-iso-date="{% if item.tracking %}{{ item.tracking.created_at|date:'c' }}{% endif %}">
                        {% if item.tracking %}
                            Cargando...
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="active-cell">
                        {% if item.tracking and item.tracking.active %}
                        <span style="color: #4CAF50; font-weight: bold;">‚úÖ</span>
                        {% else %}
                        <span style="color: #dc3545; font-weight: bold;">‚ùå</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="delete-item-btn" data-id="{{ item.id }}">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 15px;">
            <button id="save-tracked">üíæ Guardar selecci√≥n</button>
            <button id="delete-selected-items">üóëÔ∏è Eliminar seleccionados</button>
            <button id="delete-all-items">üî• Eliminar todos</button>
        </div>
    </div>

    <hr>

    <h2 id="arbitrage-results-title" class="collapsible">üìà Resultados de arbitraje</h2>
    <div id="arbitrage-results-container" style="display: none;">
        {% if snapshots %}
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-snapshots"></th>
                    <th>Item ID</th>
                    <th>Item</th>
                    <th>Icono</th>
                    <th>Snapshot tomado</th>
                    <th>Profesi√≥n</th>
                    <th>Buy Realm</th>
                    <th>Buy Price</th>
                    <th>Sell Realm</th>
                    <th>Sell Price</th>
                    <th>Profit</th>
                </tr>
            </thead>
            <tbody>
                {% for s in snapshots %}
                <tr>
                    <td><input type="checkbox" class="snapshot-check" value="{{ s.id }}"></td>
                    <td>{{ s.item.blizzard_id }}</td>
                    <td>
                        {{ s.item.name }}
                        {% if s.item.icon and "inv_misc_rune" not in s.item.icon.url %}
                        <span class="decor-badge" style="font-size: 0.7em; color: #ffc107; margin-left: 5px;">
                            {% if "decor" in s.item.name|lower %}
                            üé®
                            {% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.item.icon %}
                        <img src="{{ s.item.icon.url }}" alt="{{ s.item.name }} icon" style="width: 50px; height: 50px;">
                        {% else %}
                        <img src="https://wow.zamimg.com/images/wow/icons/large/inv_misc_rune_01.jpg"
                            alt="{{ s.item.name }} icon"
                            style="width: 50px; height: 50px;">
                        {% endif %}
                    </td>
                    <td class="date-cell" data-iso-date="{{ s.created_at|date:'c' }}">
                        Cargando...
                    </td>
                    <td class="profession-cell">
                        {% if s.item.profession %}
                        <span class="profession-badge" style="
                            background-color: {% if s.item.profession.name == 'Alchemy' %}#ff6b6b
                                            {% elif s.item.profession.name == 'Blacksmithing' %}#4ecdc4
                                            {% elif s.item.profession.name == 'Enchanting' %}#45b7d1
                                            {% elif s.item.profession.name == 'Engineering' %}#96ceb4
                                            {% elif s.item.profession.name == 'Herbalism' %}#feca57
                                            {% elif s.item.profession.name == 'Inscription' %}#ff9ff3
                                            {% elif s.item.profession.name == 'Jewelcrafting' %}#54a0ff
                                            {% elif s.item.profession.name == 'Leatherworking' %}#5f27cd
                                            {% elif s.item.profession.name == 'Mining' %}#8395a7
                                            {% elif s.item.profession.name == 'Skinning' %}#ff9f43
                                            {% elif s.item.profession.name == 'Tailoring' %}#ee5a24
                                            {% elif s.item.profession.name == 'Cooking' %}#10ac84
                                            {% elif s.item.profession.name == 'Fishing' %}#0abde3
                                            {% elif s.item.profession.name == 'Archaeology' %}#576574
                                            {% else %}#6c757d{% endif %};
                            color: white;
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-size: 0.75em;
                            white-space: nowrap;
                            display: inline-block;
                        ">
                            {{ s.item.profession.name }}
                        </span>
                        {% else %}
                        <span style="color: #94a3b8; font-style: italic; font-size: 0.85em;">-</span>
                        {% endif %}
                    </td>
                    <td>{{ s.best_buy_realm.name }}</td>
                    <td>{{ s.buy_price }} g</td>
                    <td>{{ s.best_sell_realm.name }}</td>
                    <td>{{ s.estimated_sell_price }} g</td>
                    <td class="profit">{{ s.profit }} g</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 15px;">
            <button id="delete-selected">üóëÔ∏è Eliminar seleccionados</button>
            <button id="delete-all">üî• Eliminar todos</button>
        </div>
        {% else %}
        <p>No arbitrage data available yet.</p>
        {% endif %}
    </div>

    <!-- JS externo dividido por m√≥dulos -->
    <script src="{% static 'market/js/core.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/utils.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/txt-import.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/config.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/auctions.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/items.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/snapshots.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/add-item.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/audio.js' %}?{% now 'U' %}"></script>
    <script src="{% static 'market/js/collapsible.js' %}?{% now 'U' %}"></script>
</body>
</html>