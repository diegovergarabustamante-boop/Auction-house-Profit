{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Arbitrage Scanner</title>

    <link rel="stylesheet" href="{% static 'market/css/home.css' %}">
</head>

<body>

<h1>ğŸª™ WoW Auction Arbitrage</h1>

{% if snapshots %}
<table>
    <thead>
        <tr>
            <th>
                <input type="checkbox" id="select-all">
            </th>
            <th>Item</th>
            <th>Buy Realm</th>
            <th>Buy Price</th>
            <th>Sell Realm</th>
            <th>Sell Price</th>
            <th>Profit</th>
        </tr>
    </thead>

    <tbody>
        {% for s in snapshots %}
        <tr>
            <td>
                <input
                    type="checkbox"
                    class="row-check"
                    value="{{ s.id }}"
                >
            </td>
            <td>{{ s.item.name }}</td>
            <td class="realm">{{ s.best_buy_realm.name }}</td>
            <td>{{ s.buy_price }} g</td>
            <td class="realm">{{ s.best_sell_realm.name }}</td>
            <td>{{ s.estimated_sell_price }} g</td>
            <td class="profit">{{ s.profit }} g</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 15px;">
    <button id="delete-selected">ğŸ—‘ï¸ Eliminar seleccionados</button>
    <button id="delete-all">ğŸ”¥ Eliminar todos</button>
</div>



{% else %}
<p>No arbitrage data available yet.</p>
{% endif %}

</body>
</html>


<button id="update-btn">ğŸ”„ Update Auctions</button>



<div id="progress-box">
    <p>â³ Estado: <span id="state">Idle</span></p>
    <p>ğŸŒ Reino actual: <span id="current">-</span></p>
    <p>ğŸ“Š Progreso: <span id="done">0</span>/<span id="total">0</span></p>
    <p>â±ï¸ Tiempo: <span id="elapsed">0</span>s</p>
    <p>âŒ› ETA: <span id="eta">0</span>s</p>
</div>
<script>
const btn = document.getElementById("update-btn");

let poller = null;
let wasRunning = false;

function startPolling() {
    if (poller) return;

    poller = setInterval(updateStatus, 2000);
}

function stopPolling() {
    if (poller) {
        clearInterval(poller);
        poller = null;
    }
}

function updateStatus() {
    fetch("{% url 'auction_status' %}")
        .then(r => r.json())
        .then(data => {

            if (data.running) {
                wasRunning = true;

                document.getElementById("state").innerText = "Running";
                document.getElementById("current").innerText = data.current || "-";
                document.getElementById("done").innerText = data.done || 0;
                document.getElementById("total").innerText = data.total || 0;
                document.getElementById("elapsed").innerText = data.elapsed || 0;
                document.getElementById("eta").innerText = data.eta || 0;

                btn.disabled = true;

            } else {
                document.getElementById("state").innerText = "Idle";
                btn.disabled = false;

                stopPolling(); // ğŸ›‘ dejamos de consultar

                if (wasRunning) {
                    location.reload();
                }
            }
        });
}

// ğŸš€ iniciar update
btn.addEventListener("click", () => {
    btn.disabled = true;

    fetch("{% url 'update_auctions' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    });

    startPolling(); // ğŸ”¥ solo aquÃ­ arrancamos polling
});
</script>

<script>
const selectAll = document.getElementById("select-all");
const deleteSelectedBtn = document.getElementById("delete-selected");
const deleteAllBtn = document.getElementById("delete-all");

// âœ… seleccionar / deseleccionar todos
selectAll?.addEventListener("change", () => {
    document.querySelectorAll(".row-check").forEach(cb => {
        cb.checked = selectAll.checked;
    });
});

// ğŸ—‘ï¸ eliminar seleccionados
deleteSelectedBtn?.addEventListener("click", () => {
    const ids = Array.from(document.querySelectorAll(".row-check:checked"))
        .map(cb => cb.value);

    if (ids.length === 0) {
        alert("No hay elementos seleccionados");
        return;
    }

    if (!confirm(`Eliminar ${ids.length} registros?`)) return;

    fetch("{% url 'delete_snapshots' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ ids })
    }).then(() => location.reload());
});

// ğŸ”¥ eliminar todos
deleteAllBtn?.addEventListener("click", () => {
    if (!confirm("âš ï¸ Eliminar TODOS los registros?")) return;

    fetch("{% url 'delete_all_snapshots' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    }).then(() => location.reload());
});
</script>
